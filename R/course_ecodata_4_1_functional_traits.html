<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Markus Bauer  ">
<meta name="dcterms.date" content="2024-09-19">

<title>Analysis of Ecological Data   How to get functional traits?</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="course_ecodata_4_1_functional_traits_files/libs/clipboard/clipboard.min.js"></script>
<script src="course_ecodata_4_1_functional_traits_files/libs/quarto-html/quarto.js"></script>
<script src="course_ecodata_4_1_functional_traits_files/libs/quarto-html/popper.min.js"></script>
<script src="course_ecodata_4_1_functional_traits_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="course_ecodata_4_1_functional_traits_files/libs/quarto-html/anchor.min.js"></script>
<link href="course_ecodata_4_1_functional_traits_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="course_ecodata_4_1_functional_traits_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="course_ecodata_4_1_functional_traits_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="course_ecodata_4_1_functional_traits_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="course_ecodata_4_1_functional_traits_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#preparation" id="toc-preparation" class="nav-link active" data-scroll-target="#preparation"><span class="header-section-number">1</span> Preparation</a>
  <ul class="collapse">
  <li><a href="#load-libraries" id="toc-load-libraries" class="nav-link" data-scroll-target="#load-libraries"><span class="header-section-number">1.1</span> Load libraries</a></li>
  <li><a href="#the-example-data-set" id="toc-the-example-data-set" class="nav-link" data-scroll-target="#the-example-data-set"><span class="header-section-number">1.2</span> The example data set</a></li>
  <li><a href="#load-data" id="toc-load-data" class="nav-link" data-scroll-target="#load-data"><span class="header-section-number">1.3</span> Load data</a></li>
  </ul></li>
  <li><a href="#calculate-traits-from-measured-values" id="toc-calculate-traits-from-measured-values" class="nav-link" data-scroll-target="#calculate-traits-from-measured-values"><span class="header-section-number">2</span> Calculate traits from measured values</a></li>
  <li><a href="#traits-from-databases" id="toc-traits-from-databases" class="nav-link" data-scroll-target="#traits-from-databases"><span class="header-section-number">3</span> Traits from databases</a>
  <ul class="collapse">
  <li><a href="#metadata-of-traits" id="toc-metadata-of-traits" class="nav-link" data-scroll-target="#metadata-of-traits"><span class="header-section-number">3.1</span> Metadata of traits</a></li>
  <li><a href="#get-trait-values" id="toc-get-trait-values" class="nav-link" data-scroll-target="#get-trait-values"><span class="header-section-number">3.2</span> Get trait values</a>
  <ul class="collapse">
  <li><a href="#raw-data-and-aggregated-data" id="toc-raw-data-and-aggregated-data" class="nav-link" data-scroll-target="#raw-data-and-aggregated-data"><span class="header-section-number">3.2.1</span> Raw data and aggregated data</a></li>
  <li><a href="#get-the-references-of-the-measurements" id="toc-get-the-references-of-the-measurements" class="nav-link" data-scroll-target="#get-the-references-of-the-measurements"><span class="header-section-number">3.2.2</span> Get the references of the measurements</a></li>
  <li><a href="#download-traits" id="toc-download-traits" class="nav-link" data-scroll-target="#download-traits"><span class="header-section-number">3.2.3</span> Download traits</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#name-resolving" id="toc-name-resolving" class="nav-link" data-scroll-target="#name-resolving"><span class="header-section-number">4</span> Name resolving</a></li>
  <li><a href="#merge" id="toc-merge" class="nav-link" data-scroll-target="#merge"><span class="header-section-number">5</span> Merge</a></li>
  <li><a href="#save" id="toc-save" class="nav-link" data-scroll-target="#save"><span class="header-section-number">6</span> Save</a></li>
  <li><a href="#your-own-dataset" id="toc-your-own-dataset" class="nav-link" data-scroll-target="#your-own-dataset"><span class="header-section-number">7</span> Your own dataset</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Analysis of Ecological Data <br> How to get functional traits?</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p><b>Markus Bauer</b> <br> </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2024-09-19</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Technichal University of Munich, TUM School of Life Sciences, Chair of Restoration Ecology, Emil-Ramann-Straße 6, 85354 Freising, Germany</p>
<p><a href="mailto:markus1.bauer@tum.de">markus1.bauer@tum.de</a></p>
<p><img src="https://info.orcid.org/wp-content/uploads/2019/11/orcid_16x16.png" alt="ORCID logo" width="20" height="20"><a href="https://orcid.org/0000-0001-5372-4174" class="uri">https://orcid.org/0000-0001-5372-4174</a></p>
<p><a href="https://scholar.google.de/citations?user=oHhmOkkAAAAJ&amp;hl=de&amp;oi=ao"><img src="https://img.shields.io/badge/Google%20Scholar-4285F4?style=for-the-badge&amp;logo=google-scholar&amp;logoColor=white.png" class="img-fluid" alt="GoogleScholar"></a> <a href="https://github.com/markus1bauer"><img src="https://img.shields.io/badge/github-%23121011.svg?style=for-the-badge&amp;logo=github&amp;logoColor=white" class="img-fluid" alt="GitHub"></a></p>
<section id="preparation" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Preparation</h1>
<section id="load-libraries" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="load-libraries"><span class="header-section-number">1.1</span> Load libraries</h2>
<p>You can always install missing libraries by <code>install.packages()</code> like <code>install.packages("here")</code>. We use the <code>tidyverse</code> package (Wickham et al.&nbsp;<a href="https://doi.org/10.21105/joss.01686">2019</a>), the <code>GIFT</code> package (Denelle et al.&nbsp;<a href="https://doi.org/10.1111/2041-210X.14213">2023</a>) and the package <code>TNRS</code> (Boyle et al.<a href="https://doi.org/10.1186/1471-2105-14-16">2013</a>)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GIFT)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(TNRS)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-example-data-set" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="the-example-data-set"><span class="header-section-number">1.2</span> The example data set</h2>
<p>A study in the Ammer valley before and after the weir in the <a href="https://www.openstreetmap.org/#map=16/47.7737/10.9615">floodplain Schnalz</a>.</p>
<p>Normally there are alluvial grey alder forests (Alnetum incanae, alliance <a href="https://floraveg.eu/vegetation/overview/Alnion%20incanae">Alnion incanae</a>, EUNIS habitat <a href="https://floraveg.eu/habitat/overview/T12">T12</a>)</p>
<p>Due to the dam along the Ammer and the weir in the Ammer the flood regime changed and the vegetation could have developed to a maple-ash forest (‘Edellaubholzwald’) (Adoxo-Aceretum, alliance <a href="https://floraveg.eu/vegetation/overview/Tilio-Acerion">Tilio-Acerion</a>, EUNIS habitat type <a href="https://floraveg.eu/habitat/overview/T1F%3E">T1F</a>)</p>
<p>The dataset is also available on <a href="https://doi.org/10.5281/zenodo.6054867">Zenodo</a> (Bauer et al.&nbsp;<a href="https://doi.org/10.14471/2018.38.006">2018</a>)</p>
</section>
<section id="load-data" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="load-data"><span class="header-section-number">1.3</span> Load data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>species_ammer <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"raw"</span>, <span class="st">"example_course_alluvial_forest_mb"</span>, <span class="st">"data_raw_species.csv"</span>),</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_names =</span> <span class="cn">TRUE</span>, <span class="at">col_types =</span> <span class="fu">cols</span>(<span class="at">.default =</span> <span class="st">"?"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(layer <span class="sc">==</span> <span class="st">"h"</span>) <span class="sc">%&gt;%</span> <span class="co"># select only the herbal layer, but not tree or shrub layer</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>layer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#top">Back to top</a></p>
</section>
</section>
<section id="calculate-traits-from-measured-values" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Calculate traits from measured values</h1>
<p>A short example how to calculate functional traits by your own. For example the specific leaf area (SLA) of trees (<em>Acer platanoides</em> and <em>Tilia cordata</em>) in a greenhouse experiment in Dürnast (Bauer et al.&nbsp;<a href="https://doi.org/10.1007/s00468-023-02391-8">2023</a>).</p>
<p>Per tree, three leaves were chosen and the leaf area was measured and latter the dry weight (Perez-Harguindeguy et al.&nbsp;<a href="https://www.uv.es/jgpausas/papers/PerezHarguindeguy-2013-AJB_traits-handbook2.pdf">2013</a>, section 3.1).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>traits_bricks <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"raw"</span>, <span class="st">"example_course_brick_trees_mb"</span>, <span class="st">"data_raw.csv"</span>),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_names =</span> <span class="cn">TRUE</span>, <span class="at">col_types =</span> <span class="fu">cols</span>(<span class="at">.default =</span> <span class="st">"?"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>traits_bricks <span class="sc">%&gt;%</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(plot, block, species, <span class="fu">starts_with</span>(<span class="st">"leaf"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
  plot      block species leaf1Mass leaf2Mass leaf3Mass leaf1Area leaf2Area
  &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1 AY30Amyac A     Acer         0.69      0.47      0.64     107.       82.5
2 AY30Anoac A     Acer         0.24      0.3       0.26      40.2      53.3
3 AY30Tmyac A     Tilia        0.18      0.15      0.15      34.4      32.3
4 AY30Tnoac A     Tilia        0.12      0.11      0.09      24.4      22.3
5 BY30Amyac B     Acer         0.42      0.75      0.61      65.1      92.7
6 BY30Anoac B     Acer         0.71      0.46      0.57     102.       73.4
# ℹ 1 more variable: leaf3Area &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Divide the leaf area by the leaf mass:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> traits_bricks <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">sla1 =</span> leaf1Area <span class="sc">/</span> leaf1Mass,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sla2 =</span> leaf2Area <span class="sc">/</span> leaf2Mass,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">sla3 =</span> leaf3Area <span class="sc">/</span> leaf3Mass,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">sla_mean =</span> (sla1 <span class="sc">+</span> sla2 <span class="sc">+</span> sla3) <span class="sc">/</span> <span class="dv">3</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">8</span>, <span class="fu">starts_with</span>(<span class="st">"leaf"</span>), <span class="fu">starts_with</span>(<span class="st">"sla"</span>))</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>data <span class="sc">%&gt;%</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(plot, species, <span class="fu">starts_with</span>(<span class="st">"sla"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 100 × 6
   plot      species  sla1  sla2  sla3 sla_mean
   &lt;chr&gt;     &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
 1 AY30Amyac Acer     155.  176.  176.     169.
 2 AY30Anoac Acer     168.  178.  169.     171.
 3 AY30Tmyac Tilia    191.  215.  193.     200.
 4 AY30Tnoac Tilia    203.  203.  244.     217.
 5 BY30Amyac Acer     155   124.  143.     141.
 6 BY30Anoac Acer     144.  160.  147.     150.
 7 BY30Tmyac Tilia    186.  164.  171      173.
 8 BY30Tnoac Tilia    177.  161.  190      176.
 9 CY30Amyac Acer     147.  152.  144.     148.
10 CY30Anoac Acer     141.  149.  141.     143.
# ℹ 90 more rows</code></pre>
</div>
</div>
<p><a href="#top">Back to top</a></p>
</section>
<section id="traits-from-databases" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Traits from databases</h1>
<p><a href="https://biogeomacro.github.io/GIFT/articles/GIFT.html#trait-data">Original vignette</a> (Denelle &amp; Weigelt 2024)</p>
<p>Get the functional trait values from the Global Inventory of Floras and Traits (GIFT) database (Weigelt et al.&nbsp;<a href="https://doi.org/10.1111/jbi.13623">2023</a>) with the package <code>GIFT</code> (Denelle et al.&nbsp;<a href="https://doi.org/10.1111/2041-210X.14213">2023</a>).</p>
<section id="metadata-of-traits" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="metadata-of-traits"><span class="header-section-number">3.1</span> Metadata of traits</h2>
<p>There are many functional traits available in the GIFT database. Each of these traits has an identification number called <code>trait_ID</code>. Since the two functions for retrieving trait values, <code>GIFT_traits()</code> and <code>GIFT_traits_raw()</code>, rely on these IDs, the first step is to call the function <code>GIFT_traits_meta()</code> to know what the ID of the desired trait is. For example, let’s say we want to retrieve the maximum vegetative heights of plant species.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>trait_meta <span class="ot">&lt;-</span> GIFT<span class="sc">::</span><span class="fu">GIFT_traits_meta</span>()</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>trait_meta <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(Trait2, <span class="st">"height"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Lvl1     Category Lvl2       Trait1   Lvl3            Trait2 Units    type
1    1   Morphology  1.6 Plant height  1.6.1  Plant_height_min     m numeric
2    1   Morphology  1.6 Plant height  1.6.2  Plant_height_max     m numeric
3    1   Morphology  1.6 Plant height  1.6.3 Plant_height_mean     m numeric
4    3 Reproduction 3.12  Seed height 3.12.1   Seed_height_min    mm numeric
5    3 Reproduction 3.12  Seed height 3.12.2   Seed_height_max    mm numeric
6    3 Reproduction 3.15 Fruit height 3.15.1  Fruit_height_min    cm numeric
7    3 Reproduction 3.15 Fruit height 3.15.2  Fruit_height_max    cm numeric
8    3 Reproduction 3.15 Fruit height 3.15.3 Fruit_height_mean    cm numeric
  comment count
1    &lt;NA&gt; 43353
2    &lt;NA&gt; 70367
3    &lt;NA&gt; 23219
4    &lt;NA&gt;     7
5    &lt;NA&gt;   148
6    &lt;NA&gt;    54
7    &lt;NA&gt;    54
8    &lt;NA&gt;    54</code></pre>
</div>
</div>
<p>We can see that the ID of this trait is 1.6.2. Now that we have the ID, we can use <code>GIFT_traits()</code> to retrieve the growth form values for different plant species.</p>
<p><a href="#top">Back to top</a></p>
</section>
<section id="get-trait-values" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="get-trait-values"><span class="header-section-number">3.2</span> Get trait values</h2>
<section id="raw-data-and-aggregated-data" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="raw-data-and-aggregated-data"><span class="header-section-number">3.2.1</span> Raw data and aggregated data</h3>
<p>There are two functions to access trait values. First, <code>GIFT_traits_raw()</code> returns all trait values for a given species and a given trait. These trait values can then vary. Second, <code>GIFT_traits()</code> returns an aggregated trait value at the species level. The aggregation simply takes the mean for continuous traits or the most frequent entry for categorical traits. However, for some specific cases, the aggregation takes either the minimum or the maximum, as for the trait we chose. Let’s retrieve the raw and aggregated values for the maximum vegetative height of plants (trait_ID 1.6.2).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>height <span class="ot">&lt;-</span> GIFT<span class="sc">::</span><span class="fu">GIFT_traits</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">trait_IDs =</span> <span class="fu">c</span>(<span class="st">"1.6.2"</span>), <span class="at">agreement =</span> <span class="fl">0.66</span>, <span class="at">bias_ref =</span> <span class="cn">FALSE</span>, <span class="at">bias_deriv =</span> <span class="cn">FALSE</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>height_raw <span class="ot">&lt;-</span> GIFT<span class="sc">::</span><span class="fu">GIFT_traits_raw</span>(<span class="at">trait_IDs =</span> <span class="fu">c</span>(<span class="st">"1.6.2"</span>))</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Raw values</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>height_raw <span class="sc">%&gt;%</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(work_species, trait_ID, trait_value) <span class="sc">%&gt;%</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(work_species <span class="sc">==</span> <span class="st">"Fagus sylvatica"</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregated value</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>height <span class="sc">%&gt;%</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(work_species <span class="sc">==</span> <span class="st">"Fagus sylvatica"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There were three maximum heights for Fagus sylvatica, 30, 35, and 50 meters, which led to an aggregated value of 50 meters.</p>
<p><a href="#top">Back to top</a></p>
</section>
<section id="get-the-references-of-the-measurements" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="get-the-references-of-the-measurements"><span class="header-section-number">3.2.2</span> Get the references of the measurements</h3>
<p>If you want to look up the references that led to the aggregated trait value, you can run this chunk:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>references <span class="ot">&lt;-</span> GIFT<span class="sc">::</span><span class="fu">GIFT_references</span>(<span class="at">GIFT_version =</span> <span class="st">"latest"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(<span class="fu">unlist</span>(<span class="fu">strsplit</span>(height<span class="sc">$</span>references_1.<span class="fl">6.2</span>, <span class="st">","</span>)))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>references <span class="ot">&lt;-</span> references[</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which</span>(</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    references<span class="sc">$</span>ref_ID <span class="sc">%in%</span> <span class="fu">unique</span>(</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unlist</span>(<span class="fu">strsplit</span>(height<span class="sc">$</span>references_1.<span class="fl">6.2</span>, <span class="st">","</span>))</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    ), ]</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>references[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#top">Back to top</a></p>
</section>
<section id="download-traits" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="download-traits"><span class="header-section-number">3.2.3</span> Download traits</h3>
<p>Here is an example how to download several traits:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>trait_ids <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"1.2.2"</span>, <span class="st">"1.5.1"</span>, <span class="st">"1.6.3"</span>, <span class="st">"3.2.3"</span>, <span class="st">"3.3.1"</span>, <span class="st">"3.6.1"</span>, <span class="st">"3.7.1"</span>, <span class="st">"3.21.1"</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"4.1.3"</span>, <span class="st">"4.5.1"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>trait_meta <span class="sc">%&gt;%</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Lvl3 <span class="sc">%in%</span> trait_ids) <span class="co"># Get an overview of selected traits</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>data_gift <span class="ot">&lt;-</span> GIFT<span class="sc">::</span><span class="fu">GIFT_traits</span>(</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">trait_IDs =</span> trait_ids,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">agreement =</span> <span class="fl">0.66</span>, <span class="at">bias_ref =</span> <span class="cn">FALSE</span>, <span class="at">bias_deriv =</span> <span class="cn">FALSE</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">setdiff</span>(<span class="fu">ls</span>(), <span class="fu">c</span>(<span class="st">"species_ammer"</span>, <span class="st">"traits_ammer"</span>, <span class="st">"data_gift"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#top">Back to top</a></p>
</section>
</section>
</section>
<section id="name-resolving" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Name resolving</h1>
<p><a href="https://cran.r-project.org/web/packages/TNRS/vignettes/TNRS_vignette.html">Original vignette</a> (Maitner 2024)</p>
<p>Use the Taxonomic Names Resolution Service (<a href="https://tnrs.biendata.org/">TNRS</a>) with the package <code>TNRS</code> (Boyle et al.<a href="https://doi.org/10.1186/1471-2105-14-16">2013</a>) for name resolving and the taxonoic resouces World Checklist of Vascular Plants of Kew Gardens (Govaerts <a href="http://sftp.kew.org/pub/data-repositories/WCVP/">2023</a>) and World Flora Online (WFO Consortium <a href="https://doi.org/10.5281/zenodo.8079052">2023</a>)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>metadata <span class="ot">&lt;-</span> TNRS<span class="sc">::</span><span class="fu">TNRS_metadata</span>()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> species_ammer <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowid_to_column</span>(<span class="st">"id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, name) <span class="sc">%&gt;%</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  TNRS<span class="sc">::</span><span class="fu">TNRS</span>(</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">sources =</span> <span class="fu">c</span>(<span class="st">"wcvp"</span>, <span class="st">"wfo"</span>),</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">classification =</span> <span class="st">"wfo"</span>, <span class="co"># family classification</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">mode =</span> <span class="st">"resolve"</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>names <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    Name_submitted, Taxonomic_status, Accepted_name, Accepted_name_url,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    Accepted_family</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(tolower)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#top">Back to top</a></p>
</section>
<section id="merge" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Merge</h1>
<p>Merge the resolved species names and the functional plant traits into the existing tables ‘species’ and create a new one ‘traits’. First, you have to check for duplicates in the column ‘accepted_name’ created by name resolving. Second, summarize duplicates by summing the abundances.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> species_ammer <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">name_submitted =</span> name) <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    names <span class="sc">%&gt;%</span> <span class="fu">select</span>(name_submitted, accepted_name), <span class="at">by =</span> <span class="st">"name_submitted"</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>duplicates <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">duplicated</span>(accepted_name))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>data2 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(accepted_name) <span class="sc">%&gt;%</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span> <span class="fu">sum</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>species_ammer <span class="ot">&lt;-</span> data2</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> names <span class="sc">%&gt;%</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    data_gift <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">accepted_name =</span> work_species), <span class="at">by =</span> <span class="st">"accepted_name"</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">growth_form_2 =</span> trait_value_1.<span class="fl">2.2</span>,</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">parasite_1 =</span> trait_value_1.<span class="fl">5.1</span>,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">plant_height_mean =</span> trait_value_1.<span class="fl">6.3</span>,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed_mass_mean =</span> trait_value_3.<span class="fl">2.3</span>,</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">flower_colour =</span> trait_value_3.<span class="fl">3.1</span>,</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">dispersal_syndrome_1 =</span> trait_value_3.<span class="fl">6.1</span>,</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">pollination_syndrome_1 =</span> trait_value_3.<span class="fl">7.1</span>,</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">flowering_start =</span> trait_value_3.<span class="fl">21.1</span>,</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">sla_mean =</span> trait_value_4.<span class="fl">1.3</span>,</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">nitrogen_fix_1 =</span> trait_value_4.<span class="fl">5.1</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>traits_ammer <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>work_ID, <span class="sc">-</span>work_author, <span class="sc">-</span><span class="fu">starts_with</span>(<span class="st">"references"</span>))</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">setdiff</span>(<span class="fu">ls</span>(), <span class="fu">c</span>(<span class="st">"species_ammer"</span>, <span class="st">"traits_ammer"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#top">Back to top</a></p>
</section>
<section id="save" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Save</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  species_ammer, <span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"processed"</span>, <span class="st">"data_processed_species_ammer.csv"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  traits_ammer, <span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"processed"</span>, <span class="st">"data_processed_traits_ammer.csv"</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#top">Back to top</a></p>
</section>
<section id="your-own-dataset" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Your own dataset</h1>
<ul>
<li><p>Select at least five functional plant traits.</p></li>
<li><p>Note the categories, IDs, unit and the version of the GIFT database for the material-and-methods section.</p></li>
<li><p>Get aggregated trait values from the GIFT database</p></li>
<li><p>Resolve names with TNRS</p></li>
<li><p>Note the version of the database from <code>metadata$version</code> and the sources of the names with <code>metadata$citations</code> for the material-and-methods section</p></li>
<li><p>Note the range of ‘Overall_score’ for your submitted species names.</p></li>
</ul>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>