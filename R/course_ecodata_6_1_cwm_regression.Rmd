---
title: "Analysis of Ecological Data <br> CWM regression approach"
author: "<b>Markus Bauer</b> <br>"
date: "<b>`r format(Sys.time(), '%Y-%m-%d')`</b>"
output:
  github_document:
    toc: true
    toc_depth: 3
    dev: png
    fig_width: 7
    fig_height: 5
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE
  )
```

**Markus Bauer**

Technichal University of Munich, TUM School of Life Sciences, Chair of
Restoration Ecology, Emil-Ramann-Straße 6, 85354 Freising, Germany

[markus1.bauer\@tum.de](mailto:markus1.bauer@tum.de)

<img src="https://info.orcid.org/wp-content/uploads/2019/11/orcid_16x16.png" alt="ORCID logo" width="20" height="20"/><https://orcid.org/0000-0001-5372-4174>

[![Google Scholar](https://img.shields.io/badge/Google%20Scholar-4285F4?style=for-the-badge&logo=google-scholar&logoColor=white)](https://scholar.google.de/citations?user=oHhmOkkAAAAJ&hl=de&oi=ao)
[![GitHub](https://img.shields.io/badge/github-%23121011.svg?style=for-the-badge&logo=github&logoColor=white)](https://github.com/markus1bauer)

# Tasks
* Make script tidy
* Include Ammer data

This tutorial uses Bello et al. ([2021](https://doi.org/10.1017/9781108628426)) and Zelený ([2021](https://www.davidzeleny.net/anadat-r/doku.php/en:cwm_fc_examples#example_3ecological_interpretation_of_the_unconstrained_axes_in_constrained_ordination_using_mean_ellenberg-like_indicator_values))

# 1 Preparation

## 1.1 Load libraries and functions

```{r libraries, message = FALSE}
library(here)
library(tidyverse)
library(patchwork)
rm(list = ls())
```

## 1.2 Load data

```{r load-data}
species_spain <- read_delim(
  here::here("data", "raw", "bello_etal-2021", "chapter5", "speciesXplotsNE.txt"),
  col_names = TRUE, delim = "\t", col_types = cols(.default = "?")
  )
traits_spain <- read_delim(
  here::here("data", "raw", "bello_etal-2021", "chapter5", "speciesXtraitsNE.txt"),
  col_names = TRUE, delim = "\t", col_types = cols(.default = "?")
  )
sites_spain <- read_delim(
  here::here("data", "raw", "bello_etal-2021", "chapter5", "environXplotsNE.txt"),
  col_names = TRUE, delim = "\t", col_types = cols(.default = "?")
  )

species_ammer <- read_csv(
  here("data", "processed", "data_processed_species.csv"),
  col_names = TRUE, col_types = cols(.default = "?")
  )
traits_ammer <- read_csv(
  here("data", "processed", "data_processed_traits.csv"),
  col_names = TRUE, col_types = cols(.default = "?")
  ) %>%
  select(
    -name, -taxonomic_status, -starts_with("accepted_"), -starts_with("cv_"), -starts_with("n_")
    )
# sites_ammer <- read_csv(
#   here("data", "processed", "data_processed_sites.csv"),
#   col_names = TRUE, col_types = cols(.default = "?")
#   )
```

<a href="#top">Back to top</a>

# 2 CWM regression

## 2.1 Spain data

### 2.1.1 Community-weighted Mean

Let’s see if CWM changes along the climatic gradient. For example, let’s explore visually a bit the results before running any analysis, just choosing some of the potential graphs (4 in this case):

```{r}
p1 <- sites_spain %>%
  ggplot(x = moisture.index, y = SLA) +
  labs(x = "Moisture Index", y = "CWM SLA [log mm2/mg]")
p2 <- sites_spain %>%
  ggplot(x = moisture.index, y = GrowhtForm_shrub) +
  labs(x = "Moisture Index", y = "Shrubs [%]")
p3 <- sites_spain %>%
  ggplot(x = moisture.index, y = LEG_1) +
  labs(x = "Moisture Index", y = "Legumes [%]")
p4 <- sites_spain %>%
  ggplot(x = moisture.index, y = LF_Th) +
  labs(x = "Moisture Index", y = "Therophytes [%]")
p1 + p2 / p3 + p4
```

We can already reach some conclusions while looking at these figures. The CWM SLA is increasing with moisture index, likely because of a decrease in shrub species with moisture. If fact, the different growth forms tend to have different SLA.

We can possibly also expect that there is slightly more leguminous species at the intermediate moisture conditions and that the presence of annuals (i.e. therophytes) is slightly higher in the two driest belts [Note that in the second driest site, with moisture index=0.5, there was overall a slightly greater grazing history that in the other sites, hence the generally strange behaviour of the points in these plots, with respect to the general trends].

We can now have a specific look at the statistics and we can also include grazing in the analysis. For example we can use a simple linear model (although maybe a REML, restricted maximum likelihood model, would have been more accurate) where we test the effect of moisture and grazing intensity on the CWM for SLA:

```{r}
m1 <- lm(SLA ~ moisture.index * grazing, data = sites_spain)
summary(m1)
```

This shows that in general the strongest effect (i.e. ‘filter’) on CWM for SLA is by the moisture index but grazing also modifies CWM for SLA, specifically increasing it (likely because of an increase in therophytes and decrease in woody species). However the effect of grazing on CWM for SLA depends on moisture (see the interaction moisture.index:grazing), with a weaker effect in more moist conditions.

<a href="#top">Back to top</a>

### 2.1.2 Functional diversity

Having looked which indices are correlated between them allows us to select fewer indices for assessing the relationship between FD and, for example, the moisture index in the different vegetation belts in the NE Spain data

```{r results = FALSE, fig.show = 'hide'}
p1 <- sites_spain %>%
  ggplot(x = moisture.index, y = richness) +
  labs(x = "Moisture Index", y = "Species richness [#]")
p2 <- sites_spain %>%
  ggplot(x = moisture.index, y = FRic) +
  labs(x = "Moisture Index", y = "Functional Richness")
p3 <- sites_spain %>%
  ggplot(x = moisture.index, y = FEve) +
  labs(x = "Moisture Index", y = "Functional Eveness")
p4 <- sites_spain %>%
  ggplot(x = moisture.index, y = FDis) +
  labs(x = "Moisture Index", y = "Functional Dispersion")
p1 + p2 / p3 + p4
```

What we see is that while the number of species is increasing with the moisture index, Functional Richness and Functional Dispersion tend to be maximized at lower or intermediate moisture sites. Hence the mechanisms that maintain species diversity seems not to be the same supporting the functional differentiation between species.

We can eventually apply different statistical tools to test the relationship with both the moisture index and grazing, as we did in the CWM exercise:

```{r results = FALSE, fig.show = 'hide'}
m2 <- lm(FDis ~ moisture.index * grazing, data = sites_spain)
summary(m2)
```

The results show a general weak positive effect of grazing on some of the FD components.

Include FDis_all ###

```{r}

```

The new results are quite different, and including Life Form improves the predictions of the model.

<a href="#top">Back to top</a>

## 2.2 Forest understory vegetation

We will use the Vltava dataset to analyse the relationship between the community-weighted mean of one of the leaf traits (specific leaf area, SLA) and one of the environmental variables (light intensity in the understory). The theory predicts that shade-tolerant species will produce leaves with higher SLA (i.e. per gram of dry mass they will produce leaves with the larger area) to optimize the gain from photosynthesis in the dim light of shaded conditions. Let's use the real data to see whether this works.

### 2.2.1 Preparation

Let's import the object `vltava` from `vltava.RData`; the object is a list of components, and among others contains also the matrix of species composition for herb species (`vltava$herbs$spe`), list of environmental variables (in our case we will use the estimated cover of the tree layer, `vltava$env$COVERE32`, as a proxy of light intensity in the understory - higher cover = less light in the understory), and leaf traits downloaded from TRY database for individual species, specifically SLA (`vltava$herbs$SLA`): 

```{r}
load(url('https://raw.githubusercontent.com/zdealveindy/anadat-r/master/data/vltava.RData'))
species_vltava <- vltava$herbs$spe
sites_vltava <- vltava$env
traits_vltava <- vltava$herbs$traits %>%
  mutate(SLA_sqrt = sqrt(SLA))
```

First, let's calculate the community-weighted mean of SLA for individual vegetation plots; since not all species have assigned trait values, we need to first make sure we delete species with missing trait values from both `vltava_spe` and `vltava_traits`:

```{r}
traits <- traits_vltava %>%
  filter(!is.na(SLA)) %>%
  arrange("name") %>% # make sure that it is in a certain order
  rownames_to_column("name")
species <- species_vltava %>%
  rownames_to_column("plot") %>%
  mutate(plot = paste0("comm", plot)) %>%
  pivot_longer(-plot) %>%
  pivot_wider(names_from = "plot", values_from = "value") %>%
  arrange("name") %>% # make sure that it is in a certain order
  semi_join(traits, by = "name") %>%
  pivot_longer(-name, names_to = "plot", values_to = "value") %>%
  pivot_wider(names_from = "name", values_from = "value") %>%
  column_to_rownames(var = "plot")
traits <- traits %>%
  column_to_rownames(var = "name")
```

### 2.2.2 Calculate an analyse CWM for individual sites

```{r}
data <- FD::dbFD(
  as.matrix(traits), species,
  CWM.type = "all",
  corr = "cailliez"
  )
```

Calculate a linear model regression of CWM SLA on the canopy cover:

```{r results = FALSE, fig.show = 'hide'}
m3 <- lm(data$CWM$SLA ~ sites_vltava$COVERE32)
anova (m3)

ggplot(data = sites_vltava, aes(y = data$CWM$SLA, x = sites_vltava$COVERE32)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Canopy cover [%]", y = "CWM SLA")
```

So far it goes well - as we see, the relationship is positive and statistically clear (P < 0.001).

The conclusion is that the relationship between CWM of SLA for herb species in the forest understory and the light availability is significant. This offers a strong suggestion that stronger light may filter the species into the community with lower SLA leaves.

Now, the problem is that even with random traits, we have actually a rather good chance to obtain a significant relationship between CWM and environmental variables. Let's see it on the same data, by permuting the SLA values among species, calculating CWM from these randomized trait values, and testing the regression of this randomized CWM on the original environmental variable.

Surprisingly, around 280 out of 1000 regressions are significant - but if the test has a correct Type I error rate, it should be around 5% = 50 (out of 1000) significant results.

<a href="#top">Back to top</a>

## 2.3 Ammer data

<a href="#top">Back to top</a>
